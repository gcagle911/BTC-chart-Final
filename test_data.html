<!DOCTYPE html>
<html>
<head>
    <title>Test Data Loading</title>
</head>
<body>
    <h1>Testing Data Loading</h1>
    <div id="output"></div>
    
    <script>
        const API_BASE = 'https://storage.googleapis.com/bananazone';
        
        function buildDailyUrl(asset, day) {
            return `${API_BASE}/coinbase/${asset}/1min/${day}.jsonl`;
        }
        
        function getDateStringWithOffset(offsetDays = 0) {
            const now = new Date();
            const utcDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            utcDate.setUTCDate(utcDate.getUTCDate() + offsetDays);
            const year = utcDate.getUTCFullYear();
            const month = String(utcDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(utcDate.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function parseJsonLines(text) {
            if (!text || text.trim() === '') {
                console.log('üìÑ Empty or null text received');
                return [];
            }
            
            const lines = text.trim().split('\n').filter(line => line.trim());
            console.log(`üìÑ Found ${lines.length} non-empty lines`);
            
            const parsed = lines.map((line, index) => {
                try {
                    return JSON.parse(line);
                } catch (e) {
                    console.warn(`Failed to parse JSON line ${index + 1}:`, line.substring(0, 100), e.message);
                    return null;
                }
            }).filter(Boolean);
            
            return parsed;
        }
        
        function normalizeApiData(items) {
            if (!Array.isArray(items)) return [];
            console.log(`üîÑ Normalizing ${items.length} items`);
            
            const normalized = items
                .map((row, index) => {
                    // Map the new data format fields
                    const time = row.t || row.time || null;
                    const price = row.mid ?? row.price ?? row.price_avg ?? row.close ?? row.open ?? row.high ?? row.low ?? null;
                    
                    // Map the spread fields from the new format
                    const spreadL5 = row.spread_L5_pct ?? row.spread_L5_pct_avg ?? row.spread_avg_L5_pct ?? null;
                    const spreadL50 = row.spread_L50_pct ?? row.spread_L50_pct_avg ?? row.spread_avg_L50_pct ?? null;
                    const spreadL100 = row.spread_L100_pct ?? row.spread_L100_pct_avg ?? row.spread_avg_L100_pct ?? null;
                    
                    if (!time || price === null || price === undefined) {
                        if (index < 3) console.warn(`‚ö†Ô∏è  Skipping row ${index}: missing time or price`, {time, price});
                        return null;
                    }
                    
                    // CRITICAL: Convert to UTC epoch milliseconds
                    const utcTimestamp = new Date(time).getTime(); // Parse as UTC
                    
                    const normalized = {
                        time, // Keep original for compatibility
                        ts: utcTimestamp, // CRITICAL: UTC epoch ms for deterministic bucketing
                        price: parseFloat(price),
                        spread_L5_pct_avg: spreadL5 ? parseFloat(spreadL5) : null,
                        spread_L50_pct_avg: spreadL50 ? parseFloat(spreadL50) : null,
                        spread_L100_pct_avg: spreadL100 ? parseFloat(spreadL100) : null,
                    };
                    
                    return normalized;
                })
                .filter(Boolean);
            
            console.log(`‚úÖ Normalized ${normalized.length} valid items`);
            if (normalized.length > 0) {
                console.log('üìä Sample normalized item:', normalized[0]);
            }
            
            return normalized;
        }
        
        async function testDataFetch() {
            const output = document.getElementById('output');
            output.innerHTML = 'Loading BTC data...';
            
            try {
                const today = getDateStringWithOffset(0);
                const url = buildDailyUrl('BTC', today);
                console.log(`üîç Fetching: ${url}`);
                
                const res = await fetch(url);
                console.log(`üì° Response status: ${res.status} ${res.statusText}`);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                
                const text = await res.text();
                console.log(`üìÑ Response length: ${text.length} characters`);
                
                const jsonLines = parseJsonLines(text);
                console.log(`üìä Parsed ${jsonLines.length} JSON lines`);
                
                const data = normalizeApiData(jsonLines);
                console.log(`‚úÖ Normalized to ${data.length} data points`);
                
                if (data.length > 0) {
                    output.innerHTML = `
                        <h2>Success! Loaded ${data.length} BTC data points</h2>
                        <h3>First data point:</h3>
                        <pre>${JSON.stringify(data[0], null, 2)}</pre>
                        <h3>Last data point:</h3>
                        <pre>${JSON.stringify(data[data.length - 1], null, 2)}</pre>
                        <h3>Current Price:</h3>
                        <p style="font-size: 24px; color: green;">$${data[data.length - 1].price.toLocaleString()}</p>
                    `;
                } else {
                    output.innerHTML = '<h2 style="color: red;">No data points after normalization</h2>';
                }
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                output.innerHTML = `<h2 style="color: red;">Error: ${error.message}</h2>`;
            }
        }
        
        // Test immediately
        testDataFetch();
    </script>
</body>
</html>