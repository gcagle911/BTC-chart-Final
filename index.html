<!DOCTYPE html>
<html>
  <head>
    <title>BTC Chart with Spread MAs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        background-color: black;
      }
      #tv_chart_container {
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="tv_chart_container"></div>

    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
      const chart = LightweightCharts.createChart(document.getElementById('tv_chart_container'), {
        layout: {
          background: { color: '#000' },
          textColor: '#d1d4dc',
        },
        grid: {
          vertLines: { color: '#222' },
          horLines: { color: '#222' },
        },
        width: window.innerWidth,
        height: window.innerHeight,
        timeScale: { timeVisible: true },
        crosshair: { mode: 0 },
        rightPriceScale: {
          scaleMargins: { top: 0.1, bottom: 0.2 },
          borderColor: 'gray',
        },
        leftPriceScale: {
          visible: true,
          borderColor: 'gray',
        },
      });

      const candleSeries = chart.addCandlestickSeries({
        priceScaleId: 'right',
      });

      const ma50Line = chart.addLineSeries({
        color: 'white',
        lineWidth: 2,
        priceScaleId: 'left',
      });

      const ma100Line = chart.addLineSeries({
        color: 'gold',
        lineWidth: 2,
        priceScaleId: 'left',
      });

      const ma200Line = chart.addLineSeries({
        color: 'magenta',
        lineWidth: 2,
        priceScaleId: 'left',
      });

      async function loadData() {
        try {
          const response = await fetch('https://btc-spread-test-pipeline.onrender.com/output.json');
          const rawData = await response.json();

          // Price candles
          const candles = rawData.map(d => ({
            time: Math.floor(new Date(d.time).getTime() / 1000),
            open: d.price,
            high: d.price,
            low: d.price,
            close: d.price,
          }));
          candleSeries.setData(candles);

          // Spread MAs as percentage (x100)
          const ma50 = rawData
            .filter(d => d.ma_50 !== null)
            .map(d => ({
              time: Math.floor(new Date(d.time).getTime() / 1000),
              value: d.ma_50 * 100,
            }));
          const ma100 = rawData
            .filter(d => d.ma_100 !== null)
            .map(d => ({
              time: Math.floor(new Date(d.time).getTime() / 1000),
              value: d.ma_100 * 100,
            }));
          const ma200 = rawData
            .filter(d => d.ma_200 !== null)
            .map(d => ({
              time: Math.floor(new Date(d.time).getTime() / 1000),
              value: d.ma_200 * 100,
            }));

          ma50Line.setData(ma50);
          ma100Line.setData(ma100);
          ma200Line.setData(ma200);
        } catch (error) {
          console.error('Error loading or parsing JSON:', error);
          const msg = document.createElement('div');
          msg.innerText = 'Failed to load data';
          msg.style.color = 'white';
          document.body.appendChild(msg);
        }
      }

      loadData();
    </script>
  </body>
</html>
